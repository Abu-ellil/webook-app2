require("dotenv").config();
const { PrismaClient } = require("@prisma/client");
const bcrypt = require("bcryptjs");

async function initDatabase() {
  console.log(
    "ğŸ”— Connecting to:",
    process.env.DATABASE_URL?.substring(0, 50) + "..."
  );

  // ä½¿ç”¨ Prisma å®¢æˆ·ç«¯è¿æ¥æ•°æ®åº“
  const prisma = new PrismaClient();

  try {
    // Prisma åº”è¯¥å·²ç»æ ¹æ® schema åˆ›å»ºäº†è¡¨ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦æ£€æŸ¥å¹¶åˆ›å»ºé»˜è®¤æ•°æ®

    // æ£€æŸ¥ Event è¡¨æ˜¯å¦å­˜åœ¨æ•°æ®
    const eventCount = await prisma.event.count();
    if (eventCount === 0) {
      console.log("âœ… No events found, adding sample event...");
      // æ·»åŠ ç¤ºä¾‹äº‹ä»¶
      await prisma.event.create({
        data: {
          id: "event-1",
          title: "Ø­ÙÙ„ Ù…ÙˆØ³ÙŠÙ‚ÙŠ Ø¹Ø±Ø¨ÙŠ",
          description: "Ø­ÙÙ„ Ù…ÙˆØ³ÙŠÙ‚ÙŠ Ù…Ù…ØªØ¹ Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„ÙÙ†Ø§Ù†ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¨",
          image: "/images/sample-event.jpg",
          date: new Date("2024-12-31T20:00:00"),
          venue: "Ø¯Ø§Ø± Ø§Ù„Ø£ÙˆØ¨Ø±Ø§ Ø§Ù„Ù…ØµØ±ÙŠØ©",
          category: "Ø­ÙÙ„ Ù…ÙˆØ³ÙŠÙ‚ÙŠ",
        }
      });
    }

    console.log("âœ… Database tables created successfully!");

    // Check if we need to create an admin user
    const adminCount = await prisma.admin.count();
    if (adminCount === 0) {
      // Hash the password for security
      const saltRounds = 10;
      const hashedPassword = await bcrypt.hash("admin123", saltRounds);

      await prisma.admin.create({
        data: {
          id: "admin-1",
          username: "admin",
          password: hashedPassword,
        }
      });
      console.log(
        "âœ… Default admin user created (username: admin, password: admin123)"
      );
    }
  } catch (error) {
    console.error("âŒ Error initializing database:", error);
  } finally {
    await prisma.$disconnect();
  }
}

initDatabase();